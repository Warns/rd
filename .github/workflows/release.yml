name: Release

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
      - '**/README.md'
      - '**/main.yml'
      - '**/release.yml'
      - '**/.gitignore'

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Install semver
        run: npm install -g semver

      - name: Set New Version
        run: |
          current_version=$(jq -r .version package.json)
          new_version=$(semver bump patch $current_version)
          echo "::set-output name=new_version::$new_version"
          jq --arg new_version "$new_version" '.version = $new_version' package.json > package.json.tmp
          mv package.json.tmp package.json

      - name: Commit and Push
        run: |
          git config --global user.email "you@example.com"
          git config --global user.name "Your Name"
          git add package.json
          git commit -m "Bump version to ${{ steps.release.outputs.new_version }}"
          git push

          echo "::set-output name=new_version::${{ steps.release.outputs.new_version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
